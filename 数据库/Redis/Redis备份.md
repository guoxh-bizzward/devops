# Redis 数据备份

redis的数据都是保存在内存中，redis数据备份可以定期的通过异步方式保存到磁盘上,该同步方式为半持久化模式，如果每一次数据变化都写入aof文件,则称为全持久化模式.

## 半持久化RDB模式

该模式是redis备份默认方式,是通过快照(snapshotting)完成,当符合在redis.conf配置文件中设置的条件时redis会自动将内存中的所有数据进行快照并存储到硬盘上,完成数据备份.

Redis进行RDB快照的条件由用户在配置文件中定义,由两个参数构成:时间和改动的键的个数.当在指定的时间内被更改的键的个数大于指定的数值时就会进行快照. 多个条件之间是 或 的关系,只要满足一个就会执行.

```
save       900    1       #900秒内有至少1个键被更改则进行快照；
save       300    10      #300秒内有至少10个键被更改则进行快照；
save       60     10000        #60秒内有至少10000个键被更改则进行快照。
```

如果要禁用自动快照,只需要将所有的save参数删除即可.

redis默认会将快照存储在redis数据目录,默认文件名为 dump.rdb



redis RDB模式手动备份有两个命令save bgsave 

```
两者的区别:
save直接调用rdbSave函数,阻塞Redis主进程,直到保存完成位置.在主进程阻塞期间,服务器不能处理客户请求;
bgsave命令主席那个之后立即返回ok,然后redis fork出一个新子进程,原来的redis进程继续处理客户端请求,而子进程负责将数据保存到磁盘,然后退出.可以通过在客户端执行lastsave命令查看相关命令,判断bgsave是否成功.
```

bgsave 在执行fork时操作系统会使用写时复制(copy-on-write)策略,即fork函数发生的一刻父子进程共享同一内存数据,当父进程更改其中某片数据时,操作系统会将该片数据复制一份以保证子进程的数据不受影响.所以新的RDB文件存储的是执行fork一刻的内存数据.

Redis在进行快照的过程中不会修改RDB文件,只有快照结束后才会将旧的文件替换成新的.也就是说任何时候RDB文件都是完整的.我们可以通过定时备份RDB文件来实现redis数据备份.

通过RDB方式实现持久化,一旦redis异常退出,就会丢失最后一次快照以后更改的所有数据,此时需要开发者根据具体的应用场合,通过组合设置自动快照条件的方式来将可能发生的数据损失控制在能够接受的范围.



## 全持久化AOF模式

如果数据很重要无法承受任何损失,可以考虑使用AOF方式进行持久化,默认redis是没有开启AOF(append only file)方式的全持久化模式.

在启动时redis会逐个执行AOF文件中的命令来将硬盘中的数据加载到内存中,载入速度相对RDB要慢一些,开启AOF持久化后每执行一条会更改redis中数据的命令,redis就会将该命令写入硬盘的AOF文件.AOF文件存储路径和RDB文件位置相同,默认文件名是appendonly.aof

Redis允许同时开启AOF和RDB,即保证数据安全又使得进行备份等操作十分容易.此时重启Redis后Redis会使用AOF文件来恢复数据,因为AOF方式持久化可能丢失的数据少,可以通过在redis.conf中通过appendonly参数开启AOF模式

```
appendonly  yes                    #开启AOF持久化功能；
appendfilename appendonly.aof          #AOF持久化保存文件名；
appendfsync always                     #每次执行写入都会执行同步，最安全也最慢；
#appendfsync everysec                  #每秒执行一次同步操作；
#appendfsync no                    #不主动进行同步操作，而是完全交由操作系统来做，每30秒一次，最快也最不安全；
auto-aof-rewrite-percentage  100      #当AOF文件大小超过上一次重写时的AOF文件大小的百分之多少时会再次进行重写，如果之前没有重写过，则以启动时的AOF文件大小为依据；
auto-aof-rewrite-min-size    64mb      #允许重写的最小AOF文件大小配置写入AOF文件后，要求系统刷新硬盘缓存的机制。
```



## 主从备份

主用来写,从用来读





