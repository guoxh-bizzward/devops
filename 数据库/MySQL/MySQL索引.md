# MySQL索引

http://blog.codinglabs.org/articles/theory-of-mysql-index.html

## 常见面试题

* 索引是什么
* 索引类型
* 为什么使用B+Tree作为索引结构
* 一次索引搜索过程
* 覆盖索引
* 索引失效场景
* 最左前缀
* 索引下推
* 大表添加索引

### 索引是什么

* 索引是一种提高数据库查询效率的数据结构

* 索引一般存储在文件中

* 适当的索引可以提高效率,过多的索引会影响数据库表的插入和更新功能

### 索引类型

#### 数据结构维度

* B+ Tree 时间复杂度 O(log(N)),所有数据都存储在叶子节点,适合范围查询
* Hash 
  * 仅能满足 "in","=","<=>"查询,不能使用范围查询
  * 检索效率高,检索的索引可以一次定位
  * 只有Memory存储引擎显式支持该索引
* Full Text MyISAM和InnoDB都支持全文索引,一般在文本类型char,text,varchar类型上使用
* R-Tree 用来对GIS数据类型创建SPATIAL索引

#### 物理存储维度

* 聚簇索引 以主键创建的索引,在叶子节点存储的是表中的数据;
* 非聚簇索引 以非主键创建的索引,在叶子节点存储的是主键和索引列

#### 逻辑维度

* 主键索引 特殊的唯一索引,不允许有空值
* 普通索引 基本索引类型,允许空值和重复值
* 联合索引 多个字段创建的索引,使用时遵循最左前缀原则
* 唯一索引 索引列的值必须是惟一的,但是允许空值(MySQL和Oracle支持多个为空值)
* 空间索引 MySQL5.7之后支持空间索引,遵循OpenGIS几何数据模型规则

### 为什么选择 B+ Tree 作为索引结构

* hash结构不适合做范围查询;
* 二叉树特殊情况下会形成链表;
* 平衡二叉树的插入或者更新需要进行左旋右旋来维持平衡,维护代价大;数量大的时候树的高度就会很高,数据存储在磁盘,这种索引结构会导致操作磁盘I/O的次数变多
* B+树是B树的升级版;

```
B+树的非叶子节点不存储数据,仅存储键值,而B树不仅存储键值而且也存储数据,这样innodb每页(默认16K)使用B+树就可以存储更多键值,树的阶数(节点的子节点树)就会更大,树就更矮更胖,这样查找数据进行磁盘IO次数就会减少,效率就会提高;
B+树索引的所有数据均存储在叶子节点,而且数据是按照顺序排列的,链表连着的.那么B+树使得范围查找,排序查找,分组查找和去重查找变得简单;
```



### B+ Tree 索引搜索过程



### 覆盖索引

回表



### 索引失效



### 最左前缀原则



### 索引下推

MySQL5.6引入了 索引下推优化,可以在索引遍历过程中,对索引包含的字段先做判断,直接过滤掉不满足的记录,减少回表次数;



### 大表添加索引

给表加索引的时候,会锁表;操作不当容易出生产事故;

可以参考一下方法:

1.先创建一张跟原表A数据结构相同的新表B。

2.在新表B添加需要加上的新索引。

3.把原表A数据导到新表B

4.rename新表B为原表的表名A，原表A换别的表名；