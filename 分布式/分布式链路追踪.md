# 分布式链路追踪 (拉勾教育)

## 数据观测 数据追踪的基石

### 端上访问

* 用户体验监控

* 日志
* 端到端 用户端到服务端的情况
* 可用率

### 应用程序

* 执行情况 响应时间,QPS等
* 资源消耗 I/O密集型和CPU密集型
* VM指标监控 JVM监控
* 容量 单个系统最大承受的容量
* 服务关系
* 应用日志
* 健康情况

### 业务监控

对具体业务产生的数据进行监控

* 业务指标能很好的体现出系统是否稳定
* 业务指标也可以衡量上线后的成效

### 基础设施

* 资源利用  I/O CPU 内存 负载 网络等

* 通信情况 主机间的网络情况

### 可观测性核心概念

* 统计指标 融合级别
* 链路追踪 请求级别
* 日志 事件

## 系统日志 保障系统稳定性的关键

### 日志功能

* 便于调试
* 快速定位问题
* 高度定制化
* 信息埋点
* 追踪数据变化

### 日志级别

* debug
* info
* warning
* error

### 日志常见来源

* 终端层 网页,App,小程序等,通过打点的形式上传到后端服务再记录下来
* 网关层 比如nginx, spring cloud zuul ,spring cloud gateway等,访问日志和错误日志
* 应用层  业务程序代码的执行位置,包括容器启动日志,请求访问日志等
* 组件层  第三方组件redis,MySQL等,包括 应用运行时产生的日志,慢查询日志
* 基础层 偏向于运维层,比如 系统日志,操作日志

## 日志编写 

### 日志实现框架

* log4j 1.x

* logback
* log4j 2.x



## 统计指标 5个9对系统文档的真正意义

### 指标功能

每一个指标都可观测的,高度可量化的

* 业务分析
* 系统运行状态

### 指标类型

* 计数器 Counter

* 仪表盘
* 直方图 多个数据聚合在一起分析
* 摘要

### 常见指标

* SLA service level agreement 服务等级协议,是服务商和用户之间的协定,规定了服务的性能和可用性

总成功数/请求总数=百分比

* Apdex Application Performance Index 应用性能指数,会用响应耗时来判断用户对应用性能的满意度并通过可量化的形式展示出来 = (满意度 + (容忍/2))/总数
  * 满意 Satisfactory    1T
  * 容忍 Tolerating       1T~4T
  * 失望 Frustrating       > 4T

## 监控指标

### 网页端

* 白屏时间 首次渲染时间
* 首屏时间 受资源下载影响

### App

* 崩溃率

* 卡顿率
* 卸载率

### 应用程序

* 业务指标
* 请求 
  * QPS 请求数量 
  * 状态码 http请求
  * 请求时间 即响应耗时
  * SLA
  * 独立用户数 用户访问数
* 数据处理
  * RPC
  * 熔断限流降级
  * 数据源
  * 自定义业务指标
* 组件协作资源
  * RPC
  * 数据库
  * 队列
  * 缓存 命中率 内存使用率 数据量
  * 请求
* VM监控
  * GC 次数,收集了多大的内存
  * 内存 年轻代,老年代 ,堆外,Metadata
  * CPU占用率
  * 类加载
  * 线程 活跃,等待,总线程数

### 通用指标

* DNS响应时间

* 建立连接时间

* SSL握手时间
* 首字节时间
* 下载内容时间

### 组件

数据中转地方,数据最终存储的位置

### 数据库 

* QPS 每秒查询数
* 查询耗时
* TPS 每秒事务数
* 主从延迟数
* 连接数
* 数据量
* VM监控 

### 队列

* Lag 待消费数据量大小

* 发送数量 生产者生产数据的内容的大小
* 消费数据  消费端消费生产者内容的数量
* 分区数

### 缓存

* 响应时间
* 缓存命中率
* 网络延迟时间
* 已使用内存
* 资源链接
* 缓存数量

### 网关层

* 请求相关 QPS,状态码等
* 错误数
* 请求处理 处理中,排队中,总请求数等

### 机器信息

* CPU
* 内存
* 磁盘
* 网络
* I/O
* 句柄 (句柄耗尽,无法发送http请求的情况)

## 指标编写

产品层

应用层

###  业务数据

用户增长模型  AR

```
Acquisition -- 获客 何处了解该产品
Activation  -- 激活
Retention   -- 暂存
Revenure    -- 营收
Referral    -- 传播
```

### 性能层

* 操作行为
  * 关键路径
  * 处理流程
  * 触发行为

* 自定义数据处理
  * 队列 
  * 线程池
  * 定时任务/大任务
* 第三方服务对接 进行人机和极验交互
  * 调用次数
  * 调用时长/错误次数

```
执行异常 记录堆栈日志 ,推荐增加一次统计指标的记录
```

### 指标函数

当前时间段的计算

avg

max/min

count

apdex

histogram 可以更直观的了解哪个时区间的请求次数最多

percentile 

percent 

与之前的某个指标计算

rate 速率 两者之间的增长率

irate 速率 

